#
# Install env bins
#
phpenv local 7.0

#
# BEGIN Installing Imagic 3.4 for PHP7 (As of 10/12/2015 PECL doesn't have Imagick for PHP7)
# 
wget https://pecl.php.net/get/imagick-3.4.0RC2.tgz
tar zxf imagick-3.4.0RC2.tgz
cd imagick-3.4.0RC2
phpize
./configure
make && make install
echo "extension=imagick.so" > /home/rof/.phpenv/versions/`php-config --version`/etc/conf.d/20-imagick.ini
phpenv rehash
printf "\n" | pecl install -f imagick
phpenv rehash
cd ..
# END OF Imagick installation`

#
# Configure Apps
#
export SYMFONY_ENV="test"
rvm use 2.2.1
nvm install 0.10.25
nvm use 0.10.25
bundle install
npm install

#
# Merge with master
#
git config user.email "phoenix-dev@kidspot.com.au"
git config user.name "Phoenix CI"
git remote remove origin
git remote add origin git@github.com:news-life-media/phoenix.git
git fetch
git merge origin/master --no-commit
# Get the Phoenix Playbook
git clone git@github.com:news-life-media/phoenix-playbook.git .playbook
#
# Params
#
cp .playbook/parameters/frontend-test.yml apps/frontend/app/config/parameters.yml
cp .playbook/parameters/cms-test.yml apps/cms/config/parameters.yml
cp .playbook/parameters/aws.yml apps/frontend/app/config/aws.yml
cp .playbook/parameters/aws.yml apps/recipes/app/config/aws.yml
cp .playbook/parameters/aws.yml apps/cms/config/aws.yml
#
# Composer
#
composer install --prefer-dist --no-interaction
#
# FRONTEND
#
cd apps/frontend
bin/console fos:js:dump
bin/console assetic:dump
cd ../..
#
# RECIPES
#
cd apps/recipes
composer install --prefer-dist --no-interaction
app/console assetic:dump
cd ../..
#
# Setup integration tests
#
# chmod -R 400 .playbook/files/
# ls -lah .playbook/files/
# scp -i .playbook/files/kidspot-utility.pem rof@1.tcp.ngrok.io:20383:redis-latest.rdb ~/
echo "daemonize yes" >> ~/sentinel.conf
echo "port 26379" >> ~/sentinel.conf
echo "sentinel monitor mymaster 127.0.0.1 6379 1" >> ~/sentinel.conf
# redis-sentinel ~/sentinel.conf